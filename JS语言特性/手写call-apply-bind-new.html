<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>æ‰‹åŠ¨å®ç°Functionçš„call/apply/bindçš„æ–¹æ³•ä»¥åŠnew</title>
</head>
<img src="./img/bind.png"/>
<img src="./img/currying1.png"/>
<img src="./img/currying2.png"/>
<body>
<script>
  console.log(
      "--------------------------------call--------------------------------"
  );
  // call å‡½æ•°å¯ä»¥æ”¹å˜å‡½æ•°è°ƒç”¨æ—¶thisçš„æŒ‡å‘ï¼Œå¹¶ä¸”è¿”å›è°ƒç”¨çš„ç»“æœ
  // å®ç°call
  // 1. å½“ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnullæ—¶ï¼Œé»˜è®¤æŒ‡å‘ window
  // 2. å‡½æ•°æ‰§è¡Œå¯èƒ½æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ä½¿ç”¨ eval() æ‰§è¡Œ
  // 3. å¯ä»¥ä¼ é€’å‚æ•° call æ¥æ”¶å‚æ•°åºåˆ— (obj,a,b,câ€¦)

  Function.prototype.mycall = function (context) {
    var context = context || window; // åˆ¤æ–­ä¼ å…¥å‚æ•°æ˜¯å¦å­˜åœ¨ï¼Œè‹¥æ— åˆ™é»˜è®¤æŒ‡å‘ window
    context.fn = this; // ç»™contextæ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ thisï¼Œå®ƒæŒ‡åƒè°ƒç”¨ call çš„å‡½æ•°
    let args = [...arguments].slice(1); // å–å‡ºç¬¬1ä¸ªä¹‹åçš„å‚æ•°
    let result = eval(`context.fn(...args)`);
    delete context.fn;
    return result;
  };

  Function.prototype._call = function (context) {
    var context = context || window;
    context.fn = this;
    let args = [...arguments].slice(1);
    let result = context.fn(...args);
    delete context.fn;
    return result;
  };

  var name = "æ—¶é—´è·³è·ƒ";
  var obj = {
    name: "å¬é£æ˜¯é£",
  };

  function fn(a, b, c) {
    console.log(a + b + c + this.name);
    return [a, b, c];
  }

  let result1 = fn.mycall(obj, "æˆ‘çš„", "åå­—", "æ˜¯"); // æˆ‘çš„åå­—æ˜¯å¬é£æ˜¯é£
  fn.mycall(null, "æˆ‘çš„", "åå­—", "æ˜¯"); // æˆ‘çš„åå­—æ˜¯æ—¶é—´è·³è·ƒ
  console.log(result1); // Array(3) [ "æˆ‘çš„", "åå­—", "æ˜¯" ]

  let result22 = fn._call(obj, "æˆ‘çš„", "åå­—", "æ˜¯");
  fn._call(null, "æˆ‘çš„", "åå­—", "æ˜¯");
  console.log(result22);
</script>

<script>
  console.log(
      "--------------------------------apply--------------------------------"
  );

  // å®ç° apply
  // 1. å½“ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnullæ—¶ï¼Œé»˜è®¤æŒ‡å‘ window
  // 2. å‡½æ•°æ‰§è¡Œå¯èƒ½æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ä½¿ç”¨ eval() æ‰§è¡Œ
  // 3. å¯ä»¥ä¼ é€’å‚æ•° apply æ¥å—ä¸€ä¸ªæ•°ç»„ (obj,[a,b,câ€¦])
  Function.prototype.myapply = function (context, list) {
    var context = context || window;
    context.fn = this;
    let result;
    if (!list) {
      result = eval(`context.fn()`);
    } else {
      // ES6 æ‹“å±•è¿ç®—ç¬¦+æ¨¡æ¿å­—ç¬¦ä¸²
      result = eval(`context.fn(...list)`);
    }
    delete context.fn;
    return result;
  };

  Function.prototype._apply = function (context, list) {
    var context = context || window;
    context.fn = this;
    let result;
    if (Array.isArray(list)) {
      result = context.fn(...list);
    } else {
      result = context.fn();
    }
    delete context.fn;
    return result;
  };
  // ES5 å­—ç¬¦ä¸²æ‹¼æ¥
  // var args = []
  // for (var i = 0, len = list.length; i < len; i++) {
  //   args.push("list[" + i + "]");
  // }
  // result = eval("obj.fn(" + args + ")")

  var name = "æ—¶é—´è·³è·ƒ";
  var obj = {
    name: "å¬é£æ˜¯é£",
  };

  function fn(a, b, c) {
    console.log(a + b + c + this.name);
    return [a, b, c];
  }

  let result2 = fn.myapply(obj, ["æˆ‘çš„", "åå­—", "æ˜¯"]); // æˆ‘çš„åå­—æ˜¯å¬é£æ˜¯é£
  fn.myapply(null, ["æˆ‘çš„", "åå­—", "æ˜¯"]); // æˆ‘çš„åå­—æ˜¯æ—¶é—´è·³è·ƒ
  console.log(result2); // Array(3) [ "æˆ‘çš„", "åå­—", "æ˜¯" ]

  let result33 = fn._apply(obj, ["æˆ‘çš„", "åå­—", "æ˜¯"]); // æˆ‘çš„åå­—æ˜¯å¬é£æ˜¯é£
  fn._apply(null, ["æˆ‘çš„", "åå­—", "æ˜¯"]); // æˆ‘çš„åå­—æ˜¯æ—¶é—´è·³è·ƒ
  console.log(result33); // Array(3) [ "æˆ‘çš„", "åå­—", "æ˜¯" ]
</script>

<script>
  console.log(
      "--------------------------------bind--------------------------------"
  );
  // Javascriptä¸­bind()æ–¹æ³•çš„ä½¿ç”¨ä¸å®ç°
  // var altwrite = document.write;
  // altwrite("hello");   æ­¤æ—¶çš„thisä¼šæŒ‡å‘ global æˆ– window

  //1.ä»¥ä¸Šä»£ç æœ‰ä»€ä¹ˆé—®é¢˜   éæ³•è°ƒç”¨æ¥å£
  //2.æ­£ç¡®æ“ä½œæ˜¯æ€æ ·çš„     altwrite.bind(document)("hello")

  // å®ç°bind é¦–å…ˆè¦è€ƒè™‘çš„é—®é¢˜æ˜¯
  // 1ã€ è°ƒç”¨è€…å¿…é¡»æ˜¯ä¸ª å‡½æ•°
  // 2ã€ bindæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª æŒ‡å®šäº† this çš„å‡½æ•°
  // 3ã€ bnidæ–¹æ³•å¯ä»¥ä¼ å…¥å‚æ•°åºåˆ— (a,b,c,...)

  // æœ¬è´¨ä¸Š bind å°±æ˜¯è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼Œç»™ä¸€ä¸ª fn è¿”å›ä¸€ä¸ªç»‘å®šäº†æŒ‡å®šthisçš„fn ğŸ‘‡
  // Function.prototype.mybind = function (obj) {
  //   var fn = this;
  //   return function () {
  //     fn.apply(obj)
  //   }
  // }

  // function bindtest(context) {
  //   let fn = this
  //   return function () {
  //     fn.apply(context)
  //   }
  // }

  var z = 0;
  var obj = {
    z: 1,
  };

  function fn(x, y) {
    this.name = "å¬é£æ˜¯é£";
    console.log("z", this.z);
    console.log("x", x);
    console.log("y", y);
    this.sayName = function () {
      console.log(this.name);
    };
  }

  fn.prototype.age = 26;
  fn.prototype.sayAge = function () {
    console.log(this.age);
  };

  var bound = fn.bind(obj, 2);
  bound(3); // 1 2 3

  console.log(
      "----newå----å¯ä»¥å‘ç°è¿™é‡Œçš„ this ä¸¢å¤±äº†ï¼Œthis æŒ‡å‘ person ,å®ƒæ²¡æœ‰ z å±æ€§---"
  );
  var person = new bound(3); // undefined 2 3 ;

  console.log(
      "---------æ„é€ å‡½æ•°çš„å±æ€§ã€prototypeä¸Šçš„å±æ€§/æ–¹æ³•ä¹Ÿéƒ½ç»§æ‰¿äº†---------"
  );
  console.log(person.name); // å¬é£æ˜¯é£
  console.log(person.age); // 26
  person.sayAge(); // 26
  person.sayName(); // å¬é£æ˜¯é£

  Function.prototype._bind = function (context) {
    if (typeof context !== "function") {
      throw new TypeError(
          "Function.prototype.bind - what is trying to be bound is not callable"
      );
    }
    let fn = this,
        args = [...arguments].slice(1),
        Fn = function () {},
        fBound = function () {
          let params = [...arguments].slice();
          fn.apply(
              this.constructor === fn ? this : context,
              args.concat(params)
          );
        };
    Fn.prototype = fn.prototype;
    fBound.prototype = new Fn();
    return fBound;
  };

  // mybind å®ç°
  Function.prototype.mybind = function (context) {
    if (typeof this !== "function") {
      throw new Error(
          "Function.prototype.bind - what is trying to be bound is not callable"
      );
    }

    let args = [...arguments].slice(1), //ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ context ;å–ä¹‹åçš„å…¨éƒ¨
        argsLength = args.length,
        fn = this,
        Fn = function () {
          // ä¸­ä»‹å‡½æ•°
        },
        fBound = function () {
          let params = [...arguments].slice(); // å–åˆ°è¿”å›çš„å‡½æ•°çš„æ‰€æœ‰å‚æ•°çš„æ•°ç»„
          // åˆ¤æ–­å½“å‰è°ƒç”¨çš„æ˜¯å¦ä¸º å®ä¾‹å¯¹è±¡; å¹¶å°†å‚æ•°éƒ½æ‹¼æ¥èµ·æ¥ä¼ é€’ç»™ fn
          fn.apply(
              this.constructor === fn ? this : context,
              args.concat(params)
          );
        };
    Fn.prototype = fn.prototype;
    fBound.prototype = new Fn();
    return fBound;
  };
  console.log(
      "------------------------------mybind---------------------------------"
  );

  var bound2 = fn.mybind(obj, 2);
  bound2(32);

  //æŸ¯é‡ŒåŒ–é€šç”¨ç‰ˆ
  function currying(fn) {
    let length = fn.length;
    let args = [];

    function closure(...args) {
      args = args.concat(...args);
      if (args.length >= length) {
        return closure;
      }
      fn.call(this, ...args);
    }

    return closure;
  }

  // const curry = (fn, arity = fn.length, ...args) => arity <= args.length ? fn(...args) : curry.bind(null, fn, arity, ...args)

  // if (!Function.prototype.bind) (function () {
  //   var ArrayPrototypeSlice = Array.prototype.slice;
  //   Function.prototype.bind = function (otherThis) {
  //     if (typeof this !== 'function') {
  //       // closest thing possible to the ECMAScript 5
  //       // internal IsCallable function
  //       throw new TypeError('Function.prototype.bind - what is trying to be bound is not callable');
  //     }
  //
  //     var baseArgs = ArrayPrototypeSlice.call(arguments, 1),
  //         baseArgsLength = baseArgs.length,
  //         fToBind = this,
  //         fNOP = function () {
  //         },
  //         fBound = function () {
  //           baseArgs.length = baseArgsLength; // reset to default base arguments
  //           baseArgs.push.apply(baseArgs, arguments);
  //           return fToBind.apply(
  //               fNOP.prototype.isPrototypeOf(this) ? this : otherThis, baseArgs
  //           );
  //         };
  //
  //     if (this.prototype) {
  //       // Function.prototype doesn't have a prototype property
  //       fNOP.prototype = this.prototype;
  //     }
  //     fBound.prototype = new fNOP();
  //
  //     return fBound;
  //   };
  // })();
</script>
<body>
<!--
new å…³é”®å­—çš„æ“ä½œ
1ã€ åˆ›å»ºä¸€ä¸ª ç©ºå¯¹è±¡
2ã€ å°† ç©ºå¯¹è±¡ çš„éšå¼åŸå‹ æŒ‡å‘ æ„é€ å‡½æ•°çš„æ˜¾ç¤ºåŸå‹
3ã€ å°† this æŒ‡å‘è¯¥ ç©ºå¯¹è±¡
4ã€ æ‰§è¡Œæ„é€ å‡½æ•°å†…éƒ¨çš„ä»£ç ï¼ˆç»™ ç©ºå¯¹è±¡æ·»åŠ å±æ€§æ–¹æ³•ç­‰ï¼‰
5ã€ è‹¥æ„é€ å‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ï¼Œåˆ™è¿”å› this(ç©ºå¯¹è±¡)

winter å¤§ä½¬çš„è§£é‡Š
â€¢ ä»¥æ„é€ å™¨çš„prototypeå±æ€§ä¸ºåŸå‹ï¼Œåˆ›å»ºæ–°å¯¹è±¡ã€‚
â€¢ å°†this(ä¹Ÿå°±æ˜¯ä¸Šä¸€å¥ä¸­çš„æ–°å¯¹è±¡)å’Œè°ƒç”¨å‚æ•°ä¼ ç»™æ„é€ å™¨ï¼Œæ‰§è¡Œã€‚
â€¢ å¦‚æœæ„é€ å™¨æ²¡æœ‰æ‰‹åŠ¨è¿”å›å¯¹è±¡ï¼Œåˆ™è¿”å›ç¬¬ä¸€æ­¥åˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™èˆå¼ƒæ‰ç¬¬ä¸€æ­¥åˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œè¿”å›æ‰‹åŠ¨returnçš„å¯¹è±¡ã€‚
-->
</body>
<script>
  console.log(
      "--------------------------------new--------------------------------"
  );
  const mynew = function (Parent, ...rest) {
    let child = Object.create(Parent.prototype);
    let result = Parent.apply(child, rest);
    return typeof result === "object" ? result : child;
  };

  function Parent(name, age) {
    this.name = name;
    this.age = age;
  }
  Parent.prototype.sayName = function () {
    console.log("æ‰“å°åå­—", this.name);
  };

  let child = mynew(Parent, "newæ“ä½œ", 20);
  console.log(child);

  const _mynew = function (Parent, ...rest) {
    let child = Object.create(Parent.prototype);
    let result = Parent.apply(child, rest);
    return typeof result === "object" ? result : child;
  };
  let child1 = _mynew(Parent, "newæ“ä½œ1", 201);
  console.log(child1);

  const __mynew = function (Parent, ...params) {
    let child = Object.create(Parent);
    let result = Parent.apply(this, params);
    return typeof result === "object" ? result : child;
  };

</script>
</body>
</html>
